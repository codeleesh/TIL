# 프로토타입 스코프 - 싱글톤 빈과 함께 사용시 문제점

## 정리

- 스프링 컨테이노에 프로토타입 스코프의 빈을 요청하면 항상 새로운 객체를 생성해서 반환
- 싱글톤 빈과 함께 사용할 때는 의도한 대로 잘 동작하지 않으므로 주의

### 스프링 컨테이너에 프토토타입 빈 직접 요청

  1. 클라이언트 A는 스프링 컨테이너에 포토로타입 빈을 요청한다.
  2. 스프링 컨테이너는 프로토타입 빈을 새로 생성해서 반환(`x01`)한다. 해당 빈의 count 필드 값은 0이다.
  3. 클라이언트는 조회한 프로토타입 빈에 `addCount()`를 호출하면서 count 필드를 +1 한다.
  - 결과적으로 프로토타입 빈(`x01`)의 count는 1이 된다.

### 스프링 컨테이너에 프로토타입 빈 직업 요청2

  1. 클라이언트B는 스프링 컨테이너에 프로토타입 빈을 요청한다.
  2. 스프링 컨테이너는 프로토타입 빈을 새로 생성해서 반환(`x02`)한다. 해당 빈의 count 필드 값은 0이다.
  3. 클라이언트는 조회한 프로토타입 빈에 `addCount()`를 호출하면서 count 필드를 +1 한다.
  - 결과적으로 포로토타입 빈(`x02`)의 count는 1이 된다.

### 싱글톤 빈에서 프로로타입 빈 사용

#### 싱글톤에서 프로토타입 빈 사용

  - `clientBean`은 싱글톤이므로, 보통 스프링 컨테이너 생성 시점에 함께 생성되고, 의존관계 주입도 발생한다.
  1. `clientBean`은 의존관계 자동 주입을 사용한다. 주입 시점에 스프링 컨테이너에 프로토타입 빈을 요청한다.
  2. 스프링 컨테이너는 프로토타입 빈을 생성해서 `clientBean`에 반환한다. 프로로타입 빈의 count 필드 값은 0이다.
  - 이제 `clitenBean`은 프로로타입 빈을 내부 필드에 보관한다.(정확히는 참조값을 보관한다.)

#### 싱글톤에서 프로토타입 빈 사용2

  - 클라이언트 A는 `clientBean`을 스프링 컨테이너에 요청해서 받는다. 싱글톤이므로 항상 같은 `clientBean`이 반환된다.
  - 3. 클라이언트 A는 `clientBean.logic()`을 호출한다.
  - 4. `clientBean`은 prototypeBean의 `addCount()`를 호출해서 프로토타입 빈의 count를 증가한다. count값이 1이 된다.

#### 싱글톤에서 프로토타입 빈 사용3

  - 클라이언트 B는 `clientBean`을 스프링 컨테이너에 요청해서 받는다. 싱글톤이므로 항상 같은 `clientBean`이 반환된다.
  - 여기서 중요한 점이 있는데, clientBean이 내부에 가지고 있는 프로토타입 빈을 이미 과거에 이미 주입이 끝난 빈이다. 주입 시점에 스프링 컨테이너에 요청해서 프로토타입 빈이 새로 생성이 된 것이지, 사용 할 때마다 새로 생성되는 것이 아니다.
  5. 클라이언트 B는 `clientBean.logic()`을 호출한다.
  6. `clientBean`은 prototypeBean의 `addCount()`를 호출해서 프로토타입 빈의 count를 증가한다. 원래 카운트 값이 1이었기 때문에 2로 증가한다.

스프링은 일반적으로 싱글톤 빈을 사용하므로, 싱글톤 빈이 프로토타입 빈을 사용하게 된다. 그런데 싱글톤 빈은 생성 시점에만 의존관계 주입을 받기 때문에, 프로토타입 빈이 새로 생성되기는 하지만, 싱글톤 빈과 함께 계속 유지되는 것이 문제다.

아마 원하는 것이 이런 것은 아닐 것이다. 프로토타입 빈을 주입 시점에만 새로 생성하는게 아니라, 사용할 때 마다 새로 생성해서 사용하는 것을 원할 것이다.

> 참고 : 여러 빈에서 같은 프로토타입 빈을 주입 받으면, 주입 받는 시점에 각각 새로운 프로토타입 빈이 생성된다. 예를 들어서 clientA, clientB가 각각 의존관계 주입을 받으면 각각 다른 인스턴스의 프로토타입 빈을 주입 받는다.
clientA -> prototype@x01
clientB -> prototype@x02
물론 사용할 때 마다 새로 생성되는 것은 아니다.

## TIP

- 단축키 라인 합치기 : command + option + N
