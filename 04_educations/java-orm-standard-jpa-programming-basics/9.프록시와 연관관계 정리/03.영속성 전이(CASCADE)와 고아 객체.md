# 영속성 전이(CASCADE)와 고아 객체

## 영속성 전이(CASCADE)

- 연관 관계 메소드와 전혀 상관 없음
- 엔티티를 영속화할 때 연관된 엔티티도 함께 영속화하는 편리함을 제공할 뿐임

### 영속성 전이 종류

- *ALL* : 모두 적용
- *PERSIST* : 영속
- *REMOVE* : 삭제
- MERGE : 병합
- REFRESH : REFRESH
- DETACH : DETACH

### 언제 사용하는가?

- 하나의 부모가 여러 자식들을 관리할때는 의미가 있음
  - 사용하는 경우
    - 게시판의 첨부파일 경로
  - 사용하지 않는 경우
    - 다른 게시판에서도 해당 첨부파일 경로를 사용하는 경우

다음과 같은 경우에는 사용이 가능합니다.

- 소유자가 하나일때는 사용 가능
  - - 단일 엔티티의 완전 종속적일때 사용 가능
- 라이프 싸이클(등록, 제거 등)이 유사할 때 사용 가능

## 고아 객체

- 부모 엔티티와 연관관계가 끊어진 자식 엔티티를 자동으로 삭제
- `orphanRemoval = true`
- 자식 엔티티를 부모 컬렉션에서 제거하면(`parent.getChildren().remove(0)`) 삭제 쿼리가 실행이 됨

### 주의할 점

- 참조가 제거된 엔티티는 다른 곳에서 참조하지 않는 고아 객체로 보고 삭제하는 기능
- 참조하는 곳이 하나일 때 사용해야함!
- 특정 엔티티가 개인 소유할 때 사용
- 개념적으로 부모를 제거하면 자식은 고아가 된다. 따라서 고아 객체 제거 기능을 활성화 하면, 부모를 제거할 때 자식도 함께 제거된다. 이것은 `CascadeType.REMOVE` 처럼 동작한다.

## 영속성 전이 + 고아 객체, 생명 주기

- `CascadeType.ALL` + `orphanRemoval = true`
- 스스로 생명주기를 관리하는 엔티티는 em.persist()로 영속화, em.remove()로 제거
- 두 옵션을 모두 활성화 하면 부모 엔티티를 통해서 자식의 생명주기를 관리할 수 있음
- 도메인 주도 설계(DDD)의 Aggregate Root 개념을 구현할 때 유용
