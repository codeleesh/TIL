# 프로세스와 쓰레드

개발자로서 일을 하면서 단순히 개발을 잘한다는 아래와 같은 질문들에 대해서 좀 더 답변을 잘할 수 없을까?

쓰레드가 무엇인가요?

그럼 멀티 프로세스는 무엇인가요?

둘의 차이는 무엇인가요?

## 용어 정리

- 프로그램
- 실행 단위
    - cpu core에서 실행하는 하나의 단위로 프로세스와 쓰레드를 포괄하는 개념
- 프로세스
    - 하나의 쓰레드만 가지고 있는 단일 쓰레드 프로세스
- 프로세서
    - 프로세스가 동작될 수 있도록 하는 하드웨어(= cpu)
- 동시성
    - 한 순간에 여러가지 일이 아니라, 짧은 전환으로 여러가지 일을 동시에 처리하는 것처럼 보이는 것, ContextSwitching

## 프로그램과 프로세스

여기 피자레시피가 있습니다. 피자레시피로 피자를 만들 수 있습니다. 너무 당연한 이야기입니다.

피자 레시피를 프로그램이라고 한다면, 피자 레시피를 이용하여 피자를 만드는 것을 프로세스라고 할 수 있습니다.

프로세스가 실행이 되면 어떠한 일이 발생할까요? 다음 2가지의 일을 수행합니다.

1. 프로세스의 필요한 재료들을 메모리에 적재
    | 항목 | 설명 |
    | --- | --- |
    | Code | 실행 명령을 포함하는 코드들 |
    | Data | Static 변수 혹은 Global 변수 |
    | Heap | 동적 메모리 영역 |
    | Stack | 지역변수, 매개변수, 반환 값 등 일시적인 데이터 |

2. 해당 프로세스의 정보를 담고 있는 PCB Block 생성
    - Ponter
    - Process State
    - Process Number(ID)
    - Program Counter
    - Registers
    - Memory limits
    - List of open files
    - ...

### 컴퓨터 사용시 예시

코딩을 하기 위해서 인텔리제이를 실행합니다. 집중을 높여주기 위해서 유투브 뮤직에서 노래도 실행합니다. 팀원들과 의견을 주고 받기 위해서 슬랙도 실행시켜야 합니다. 스마트폰으로는 조금 답답하니 카카오톡도 실행합니다.  그리고 개발을 하면서 참고자료를 검색하기 위해서 크롬도 실행합니다.

벌써 실핼시킨 프로그램이 5개가 됩니다. 프로그램은 어떠한 일을 수행하기 위해서는 프로세스를 실행시켜야 합니다. 피자레시피가 피자가 되는것처럼 말입니다.

하지만 이렇게 많은 프로세스는 어떻게 실행이 될까요?

한 프로세스가 CPU를 점유하고 있으면 다른 프로세스는 실행 상태에 있을 수 없습니다.

그래서 하나의 프로세스만 사용하기보다는 여러가지를 동시에 사용합니다.

그래서 다수의 프로세스를 동시에 실행하기 위해 여러 개 프로세스를 시분활로 전환해서 실행합니다. 이러한 작업을 `Context Switching` 라고 합니다.

### 왜 `Context Switching` 이 필요할까요?

컴퓨터가 하나의 프로세스만 처리할 수 있다면 어떻게 될까요? 개발을 할때는 노래도 듣지 못하고, 검색도 못하며, 슬랙 또는 카카오톡을 사용하지도 못하게 됩니다.

즉, 하나의 프로세스를 다 종료하고(이용하고) 다른 프로세스 실행을 해줘야 합니다.

그래서 컴퓨터의 CPU가 프로세스를 바꿔 가며 실행하기 위해서 필요하게 되었습니다.

## 쓰레드

쓰레드를 경량화된 프로세스라고 말합니다.

왜 쓰레드는 경량화된 프로세스일까요?

하나의 프로세스 안에 다수의 쓰레드가 있다면 공유하는 자원이 존재 - Code, Data, Heap

Stack 영역만 따로 갖고 있음

공유되는 자원이 있기 때문에 캐싱 적중률이 올라감

멀티 프로세스와 멀티 쓰레드

한 애플리케이션의 처리 방식의 일종

한 어플리케이션이 여러 가지 일을 처리

- 로그인 처리

부모 프로세스가 fork()를 해서 자식 프로세스를 여러 개 만들어서 일을 처리

이때 자식 프로세스는 부모와 별개의 메모리 영역을 가지고 있음

쓰레드

- 한 프로세스 내에서 구분이 되어진 실행단위

프로세스가 다수의 스레드로 구분이 되어 있지 않다면 단일 쓰레드 하나로 실행

이때 실행단위는 프로세스 그 자체

해당 프로세스의 하나밖에 없는 쓰레드가 실행 단위

프로세스 내에서 분리해서 여러 쓰레드로 나뉘어서 실행단위가 나뉘어지면 멀티 쓰레드

예시) 인텔리제이로 개발을 하면서, 추천 코드, 테스트 수행 등한 애플리케이션에서 작업의 단위가 나누어짐

이때 각각의 쓰레드가 작업을 담당

멀티 프로세스와 멀티 쓰레드의 차이점

멀티 프로세스

- 프로세스는 독립적이라서 IPC를 통해서 통신 필요
    - 같은 작업을 2명이 2개의 다른 회의실에서 회의를 진행하다가 논의할 일이 생기면 밖으로 나와서 이야기를 하고 다시 들어가야함
- 자원 소모적, 개별 메모리 차지
- Context Switching 비용이 큼
- 동기화 작업이 필요하지 않음

멀티 쓰레드

- Thread끼리 긴밀하게 연결되어 있음
    - 같은 작업을 2명이 한 회의실에서 일을 처리하기 때문에 논의할 내용이 있으면 말만 걸면됨
- 공유된 자원으로 통신 비용 절감
- 공유된 자원으로 메모리가 효율적임
- Context Switching 비용이 적음
- 공유 자원 관리를 해야함

그러면 왜 멀티 프로세스를 이용해야 할까요?

- 쓰레드는 긴밀하게 연결되어 있기 때문에 한 쓰레드가 문제가 생기면 전체 영향

멀티 코어

하드웨어측면에 가까움

동시성과 병렬처리

동시성은 짧은 순간에 cpu의 시간을 분할해서 동시에 하는 것처럼 보이게함

병렬처리는 물리적으로 여러 코어를 사용해서 다수의 실행 단위를 한 순간에 동시에 처리할 수 있게 함

리눅스에서 프로세스와 쓰레드

리눅스 커널에서는 프로세스와 쓰레드를 동일하게 봅니다.

쓰레드는 사용자 쓰레드와 커널 쓰레드로 구분

각 쓰레드를 담당하는 레벨

사용자 레벨에서 생성된 쓰레드와 커널에서 생성된 쓰레드간 연관관계 존재

- 다대일, 일대일, 일대다
- 리눅스에서는 알대일 모델
- 하나의 사용자 쓰레드당 하나의 커널 쓰레드가 매칭
- 각각의 쓰레드가 하나의 프로세스
- 그런데, 프로세스는 각각 다른 메모리를 가진 것과 다르게 메모리를 공유 → light weight process 명칭

각각의 프로세스는 pid, 즉 고유 번호를 갖고 있음

리눅스에서는 어떻게 갖고 있을까?

쓰레드가 각각의 pid를 갖고 있을까?

한 프로세스의 생성된 쓰레드는 모두 같은 pid를 갖고 있음

- tgid라는 쓰레드 그룹 아이디를 가지고 있고 tid 라는 쓰레드 아이디도 가지고 있음
- 그래서 사용자 레벨 입장에서 보면 이 쓰레드 그룹 아이디가 pid로 보여지고
- 커널 입장에서는 tid가 pid로 인식
